---
- name: Prepare for vault role
  gather_facts: true
  hosts: consul
  vars:
    consul_bind_interface: lo
    vault_bind_address: 127.0.0.1
    vault_api_addr: http://127.0.0.1:8200
    vault_config_dir: "/etc/vault"
    vault_log_keys: true
    vault_set_keys_fact: true
    vault_write_keys_file: true
  tasks:
    - name: Ensure /etc/vault exists
      file:
        path: /etc/vault
        state: directory
      become: true

    - include_role:
        name: vault

    # Idempotence test
    - include_role:
        name: vault

    - name: Unseal vault
      import_role:
        name: vault_unseal
      vars:
        vault_unseal_keys: "{{ vault_keys.keys_base64 }}"

    - name: Configure PKI
      import_role:
        name: vault_pki
      vars:
        vault_token: "{{ vault_keys.root_token }}"
        vault_pki_root_ca_name: "OS-TLS-ROOT"
        vault_pki_intermediate_ca_name: "OS-TLS-INT"
        vault_pki_root_create: true
        vault_pki_intermediate_create: true
        vault_pki_generate_certificates: True
        vault_pki_write_pem_bundle: false
        vault_pki_intermediate_roles:
          - name: "ServerCert"
            config:
              max_ttl: 8760h
              ttl: 8760h
              allow_any_name: true
              allow_ip_sans: true
              require_cn: false
              server_flag: true
              key_type: rsa
              key_bits: 4096
              country: ["UK"]
              locality: ["Bristol"]
              organization: ["StackHPC"]
              ou: ["HPC"]
        vault_pki_certificate_subject:
          - role: 'ServerCert'
            common_name: "OS-CERT-TEST"
            extra_params:
              ttl: "8760h"
              ip_sans: "127.0.0.1"
              alt_names: "example.com"
              exclude_cn_from_sans: true
    - name: Configure PKI
      import_role:
        name: vault_pki
      vars:
        vault_token: "{{ vault_keys.root_token }}"
        vault_pki_root_ca_name: "OS-TLS-ROOT"
        vault_pki_intermediate_ca_name: "OS-TLS-INT"
        vault_pki_root_create: False
        vault_pki_intermediate_create: False
        vault_pki_generate_certificates: True
        vault_pki_write_pem_bundle: True
        vault_pki_certificate_subject:
          - role: 'ServerCert'
            common_name: "OS-CERT-TEST2"
            extra_params:
              ttl: "8760h"
              ip_sans: "192.168.38.72"
              exclude_cn_from_sans: true
