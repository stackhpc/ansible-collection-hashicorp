---
- name: Ensure vault container is running
  docker_container:
    name: "{{ vault_docker_name }}"
    image: "{{ vault_docker_image }}:{{ vault_docker_tag }}"
    network_mode: host
    etc_hosts: "{{ vault_container.etc_hosts | default(omit) }}"
    capabilities: IPC_LOCK
    volumes: "{{ _vault_volumes }}"
    comparisons:
      '*': strict
    restart_policy: "always"
    env:
      VAULT_LOCAL_CONFIG: "{{ vault_config | to_json }}"
    command: >
      server
  become: True

- name: Check if vault is initialized
  uri:
    url: "{{ vault_api_addr }}/v1/sys/init"
  register: vault_init_status
  retries: 50
  delay: 1
  until: vault_init_status.status == 200

- name: Initialize vault
  hashivault_init:
    url: "{{ vault_api_addr }}"
  run_once: True
  no_log: True
  when: not vault_init_status.json.initialized
  register: vault_keys

- name: Print vault keys
  debug:
    var: vault_keys
  when: not vault_init_status.json.initialized

